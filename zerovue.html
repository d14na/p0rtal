<!DOCTYPE html>
<html>
<head>
<style>
body {
    // NOTE: We may need to update this dynamically
    //       to support imported body styles.
    margin: 0;
    padding: 0;
}
</style>

<!-- jQuery (https://jquery.com/) -->
<script src="https://cdn.0net.io/libs/jquery/3.3.1/js/jquery.min.js"></script>

<!-- Mutation Summary (https://github.com/rafaelw/mutation-summary) -->
<!-- <script src="./libs/mutation-summary.js"></script> -->

<!-- Browserified JS Libraries -->
<script src="./libs/buffer.js"></script>

<script>
/* Initialize parent manager. */
let parent = null

/* Initialize origin manager. */
let origin = null

/* Initialize DOM (Vue) master. */
let vueMaster = {}

/**
 * @notice Initialize the gateway.
 *
 * @dev We want to set the security to our parent to prevent any
 *      unauthorized communication with any "malicious" 3rd-parties
 *      who may be eavesdropping.
 */
const _init = function (_event) {
    // console.log('EVENT', _event)

    /* Validate the origin of our parent is ONLY one from an approved list. */
    if (
        _event.origin === 'http://127.0.0.1:10443' ||
        _event.origin === 'https://0net.io' ||
        _event.origin === 'https://web.0net.io'
    ) {
        /* Set security flag. */
        // isSecure = true

        /* Set the parent manager. */
        parent = _event.source

        /* Set the origin manager. */
        origin = _event.origin

        return true
    } else {
        return false
    }
}

/**
 * Send a message back to the Parent.
 */
const _msgParent = function (_message) {
    /* Validate the response. */
    if (parent && origin && _message) {
        parent.postMessage(_message, origin)
    } else {
        throw new Error('Oh no! Something smells wrong about this action.')
    }
}

window.addEventListener('message', function (_event) {
    // console.log('Gatekeeper received event', _event)

    /* Initailize body. */
    let body = null

    /* Initailize data. */
    let data = null

    /* Initailize error. */
    let error = null

    /* Initialize message. */
    let message = null

    /* Initialize msg. */
    let msg = null

    /* Initialize pkg. */
    let pkg = null

    /* Initialize success. */
    let success = null

    /* Verify parent is authorized and set. */
    if (!parent) {
        /* Attempt to initialize the gateway. */
        if (_init(_event)) {
            /* Set success flag. */
            success = true

            /* Set message. */
            msg = 'GATEKEEPER_IS_READY'

            /* Build message. */
            message = { success, msg }

            /* Message back to parent. */
            return _msgParent(message)
        } else {
            /* Set error flag. */
            error = true

            /* Set message. */
            msg = 'Authorization failed!'

            /* Build message. */
            message = { error, msg }

            /* Message back to parent. */
            return _msgParent(message)
        }
    }

    /* All messages should be JSON strings, so let's try to decode to an object. */
    try {
        /* Retrieve the data. */
        data = _event.data

        /* Validate data. */
        if (!data) {
            return
        }

        /* Perform UI update? */
        if (data.action === 'update') {
            let elem = data.elem

            let body = Buffer.from(data.body)

            let dataUrl = `data:image/jpeg;base64,${body.toString('base64')}`

            if (vueMaster[elem]) {
                console.log('FOUND UPDATE ELEMENT')

                console.log('VUE MASTER', vueMaster)

                vueMaster[elem].css('background-image', `url(${dataUrl})`)

                /* Cleanup element. */
                delete vueMaster[elem]
            }

            return
        }

        /* Retrieve html body. */
        body = data.body

        /* Validate body. */
        if (!body) {
            /* Set error flag. */
            error = true

            /* Set message. */
            msg = 'There is NO <body> to render.'

            /* Build error. */
            pkg = { error, msg }

            /* Message back to parent. */
            // return _msgParent(pkg)
            return
        }

        console.log('BODY', body)

        // FIXME Find a better (more consistent) element to replace BODY

        if (data.prepend) {
            /* Prepend the data to the frame's html body. */
            jQuery('body').prepend(body)
        } else if (data.append) {
            /* Append the data to the frame's html body. */
            jQuery('body').append(body)
        } else {
            /* Replace the data on the frame's html body. */
            jQuery('body').html(body)
        }

        /* Scroll to the top. */
        try {
            // jQuery('html, body').scrollTop(0)
        } catch (_err) {
            // FIXME Ignore this error for now:
            //       Cannot read property 'html' of undefined??
        }
    } catch (_err) {
        /* Set error flag. */
        error = true

        /* Set message. */
        msg = _err.message

        /* Build error. */
        pkg = { error, msg }

        /* Message back to parent. */
        return _msgParent(pkg)
    }
})
</script>
</head>
<body id="vueMaster"></body>
<script>
// Select the node that will be observed for mutations
const targetNode = document.getElementById('vueMaster')

// Options for the observer (which mutations to observe)
const config = {
    attributes: true,
    childList: true,
    subtree: true
}

// Callback function to execute when mutations are observed
const callback = function (mutationsList, observer) {
    // console.log('MUTATION LIST', mutationsList)

    for (let mutation of mutationsList) {
        if (mutation.type === 'childList') {
            // console.log('A child node has been added or removed.')
            if (mutation.addedNodes.length >= 1) {
                if (mutation.addedNodes[0].nodeName != '#text') {
                    // console.log('Added ' + mutation.addedNodes[0].tagName + ' tag.');
                }
            } else if (mutation.removedNodes.length >= 1) {
                // console.log('Removed ' + mutation.removedNodes[0].tagName + ' tag.')
            }
        } else if (mutation.type === 'attributes') {
            // console.log('The ' + mutation.attributeName + ' attribute was modified.')

            if (mutation.attributeName === 'style') {
                // console.log('The ' + mutation.attributeName + ' attribute was modified.')
                // console.log('STYLE MUTATION', mutation)

                let css = mutation['target'].style.cssText

                if (css && css.toUpperCase().indexOf('JPG') !== -1) {
                    // console.log('JPG MUTATION', mutation)
                    // console.log('STYLE [cssText]', css)

                    // let jDebug = jQuery('div.cover')
                    // console.log('J DEBUG', jDebug)
                    // let jDebug = jQuery('div.cover').css('background-image', 'url(' + dataUrl + ')')
                    jQuery('div').each(function (_index) {
                        /* Initialize file path. */
                        let filePath = null

                        // console.log('ELEM', _index, jQuery(this))

                        /* BACKGROUND-IMAGE */

                        /* Set background image object. */
                        let bgImg = jQuery(this)[0]['style'].backgroundImage

                        if (bgImg && bgImg.indexOf(`url(`) !== -1) {
                            // console.info('BACKGROUND IMAGE', bgImg)

                            filePath = bgImg.slice(4, -1)

                            if (filePath[0] === `'` || filePath[0] === `"`) {
                                filePath = filePath.slice(1)
                            }

                            if (filePath[filePath.length - 1] === `'` || filePath[filePath.length - 1] === `"`) {
                                filePath = filePath.slice(0, -1)
                            }

                            // FIXME Safari & iOS are prepending (https://web.0net.io/)
                            filePath = filePath.replace(/https:\/\/web.0net.io\//, '')

                            // console.info('FILE PATH', filePath)

                            if (filePath.slice(0, 15) === 'data:image/jpeg') {
                                filePath = null

                                return
                            }

                            /* Set jQuery object to vue master. */
                            vueMaster[filePath] = jQuery(this)
                        }

                        /* Validate file path. */
                        if (filePath) {
                            /* Set message. */
                            let msg = {
                                cmd: 'fileGet',
                                params: filePath
                            }

                            /* Message back to parent. */
                            _msgParent(msg)
                        }
                    })

                    // return console.log('VUE MASTER', vueMaster)
                }

                // console.log('STYLE', mutation['target'].style)
                // console.log('OUTER HTML', mutation['target'].outerHTML)

                // console.log('STYLE BACKGROUND', mutation['target'].style.background)
                // console.log('STYLE IMG', mutation['target'].style.backgroundImage)
            }
        }
    }

    // jQuery('div.cover').css('background-image', 'url(' + dataUrl + ')')
}

// Create an observer instance linked to the callback function
const observer = new MutationObserver(callback)

// Start observing the target node for configured mutations
observer.observe(targetNode, config)

// Later, you can stop observing
// observer.disconnect()
</script>
</html>
